<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>chat</title>

</head>

<body>
    <style>
        .content {
            background-color: antiquewhite;
            width: 200px;
            height: 400px;
        }
    </style>
    <div>
        <div class="content" id="content-div">

        </div>
        <div>
            <input type="text" id="send-message" />
            <button type="button" id="input">입력</button>
        </div>
        <input type="hidden" id="time" />

    </div>

    <script>
        window.onload = function () {

            let input = document.getElementById("input");
            input.addEventListener("click", () => {
                sendMessage();
            });

            function sendMessage() {
                const promise = postData("/api/message", messageData());
                promise.then((res) => {
                    console.log("send message: ");
                });

            }
            function messageData() {
                return {
                    id: "user001",
                    message: document.getElementById("send-message").value,
                };
            }

            function getMessage() {
                // const uri = new URL('/api/message');
                // uri.searchParams.append('lastDateTime', '2022-08-31 23:30:00');
                // const param = new URLSearchParams({
                //     lastDateTime: '2022-08-31 23:30:00',
                // });
                // console.log("get message date: " + data);
                const promise = getData('/api/message?lastDateTime=2022-08-31 23:30:00');
                promise.then((res) => {
                    for (let data of res) {
                        console.log("get message: " + data.message);
                        createMessageLine(data.message);
                    }
                    setTimeout(getMessage, 3000);
                })

            }

            function createMessageLine(message) {
                const view = document.getElementById("content-div");
                const li = document.createElement("li");
                li.innerText = message;
                view.append(li);
            }

            getMessage();

            async function postData(url = '', data = {}) {
                const response = await fetch(url, {
                    method: 'POST', // *GET, POST, PUT, DELETE 등
                    mode: 'cors', // no-cors, *cors, same-origin
                    cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                    credentials: 'same-origin', // include, *same-origin, omit
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    redirect: 'follow', // manual, *follow, error
                    referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                    body: JSON.stringify(data), // body의 데이터 유형은 반드시 "Content-Type" 헤더와 일치해야 함
                });
                return response.json();
            }

            async function getData(url = '') {
                const response = await fetch(url, {
                    method: 'GET',
                });
                return response.json();
            }


        }
    </script>

</body>

</html>